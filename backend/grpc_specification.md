# gRPC Service Specification

| Date       | Description                                |
| ---------- | ------------------------------------------ |
| 2026-02-14 | FEAT-USER-001: User Account Management     |

## 1. Overview

This document defines the gRPC service interfaces for nihao-chat backend services. All service definitions use proto3 syntax. Internal communication between the gateway and backend services, as well as inter-service calls, use gRPC.

## 2. Common Types

**File:** `proto/common/v1/common.proto`

```protobuf
syntax = "proto3";

package common.v1;

import "google/protobuf/timestamp.proto";

// Standard error detail included in gRPC status metadata
message ErrorDetail {
  int32 code = 1;    // Application error code (e.g., 1001)
  string message = 2; // Human-readable error message
}

// Identifier type enum
enum IdentifierType {
  IDENTIFIER_TYPE_UNKNOWN = 0;
  IDENTIFIER_TYPE_EMAIL = 1;
  IDENTIFIER_TYPE_PHONE = 2;
}

// Verification code purpose enum
enum VerificationPurpose {
  VERIFICATION_PURPOSE_UNKNOWN = 0;
  VERIFICATION_PURPOSE_REGISTRATION = 1;
  VERIFICATION_PURPOSE_PASSWORD_RESET = 2;
}

// OAuth provider enum
enum OAuthProvider {
  OAUTH_PROVIDER_UNKNOWN = 0;
  OAUTH_PROVIDER_GOOGLE = 1;
  OAUTH_PROVIDER_APPLE = 2;
}
```

## 3. Naming Conventions

| Element          | Convention          | Example                        |
| ---------------- | ------------------- | ------------------------------ |
| File             | `snake_case.proto`  | `auth_service.proto`           |
| Package          | `domain.subdomain.v1` | `auth.v1`                    |
| Message          | `PascalCase`        | `LoginRequest`                 |
| Field            | `snake_case`        | `user_id`                      |
| Service          | `PascalCase`        | `AuthService`                  |
| RPC method       | `PascalCase`        | `Login`                        |
| Enum name        | `PascalCase`        | `IdentifierType`               |
| Enum value       | `CAPS_SNAKE_CASE`   | `IDENTIFIER_TYPE_EMAIL`        |
| First enum value | `*_UNKNOWN = 0`     | `IDENTIFIER_TYPE_UNKNOWN = 0`  |

## 4. Request/Response

Every RPC must have a unique `Request` and `Response` message. Message reuse across different RPCs is strictly prohibited. This ensures each RPC can evolve independently without breaking changes.

## 5. Compatibility

- Never change existing field numbers
- Use `reserved` keyword for deprecated field tags and names
- Add new fields with new field numbers only
- Enum values must never be reordered or removed; add `reserved` for deprecated values

## 6. Pagination

List RPCs use cursor-based pagination:

```protobuf
// Include in list requests
string page_token = 1;
int32 page_size = 2;

// Include in list responses
string next_page_token = 1;
```

Avoid offset-based pagination. `page_token` is an opaque token generated by the server.

## 7. Error Handling

Errors are returned via `google.golang.org/grpc/status` with the Rich Error Model. Each error includes:

1. A gRPC status code (e.g., `INVALID_ARGUMENT`, `NOT_FOUND`)
2. An `ErrorDetail` message attached as status detail containing:
   - `code`: Application-specific error code (integer)
   - `message`: Human-readable error description

Example (Go):

```go
st := status.New(codes.InvalidArgument, "Invalid verification code")
detail := &commonpb.ErrorDetail{Code: 1004, Message: "Invalid verification code"}
st, _ = st.WithDetails(detail)
return nil, st.Err()
```

## 8. Auth Service

### 8.1 Service Definition

**File:** `proto/auth/v1/auth_service.proto`

```protobuf
syntax = "proto3";

package auth.v1;

import "common/v1/common.proto";

service AuthService {
  // Registration
  rpc SendVerificationCode(SendVerificationCodeRequest) returns (SendVerificationCodeResponse);
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // Login
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc SocialLogin(SocialLoginRequest) returns (SocialLoginResponse);

  // Token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);

  // Logout
  rpc Logout(LogoutRequest) returns (LogoutResponse);

  // Password
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse);
  rpc SendPasswordResetCode(SendPasswordResetCodeRequest) returns (SendPasswordResetCodeResponse);
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse);
}
```

### 8.2 Message Definitions

#### Registration Messages

```protobuf
message SendVerificationCodeRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
  common.v1.VerificationPurpose purpose = 3;
}

message SendVerificationCodeResponse {
  int32 expires_in = 1; // Seconds until code expires
}

message RegisterRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
  string code = 3;
  string password = 4;
  string nickname = 5;
}

message RegisterResponse {
  string user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  int32 expires_in = 4; // Access token TTL in seconds
}
```

#### Login Messages

```protobuf
message LoginRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
  string password = 3;
}

message LoginResponse {
  string user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  int32 expires_in = 4;
}

message SocialLoginRequest {
  common.v1.OAuthProvider provider = 1;
  string id_token = 2;
  string authorization_code = 3; // Required for Apple, optional for Google
}

message SocialLoginResponse {
  string user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  int32 expires_in = 4;
  bool is_new_user = 5;
}
```

#### Token Messages

```protobuf
message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int32 expires_in = 3;
}
```

#### Logout Messages

```protobuf
message LogoutRequest {
  string user_id = 1;
  string token_id = 2;
}

message LogoutResponse {}
```

#### Password Messages

```protobuf
message ChangePasswordRequest {
  string user_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message ChangePasswordResponse {}

message SendPasswordResetCodeRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
}

message SendPasswordResetCodeResponse {
  int32 expires_in = 1;
}

message ResetPasswordRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
  string code = 3;
  string new_password = 4;
}

message ResetPasswordResponse {}
```

### 8.3 Error Codes

| gRPC Status        | Reason                          | Detail Type   | Description                                                |
| ------------------ | ------------------------------- | ------------- | ---------------------------------------------------------- |
| UNAUTHENTICATED    | INVALID_CREDENTIALS             | ErrorDetail   | Email/phone or password is incorrect                       |
| PERMISSION_DENIED  | ACCOUNT_LOCKED                  | ErrorDetail   | Account locked due to excessive failed login attempts      |
| ALREADY_EXISTS     | IDENTIFIER_ALREADY_EXISTS       | ErrorDetail   | Email or phone number is already registered                |
| INVALID_ARGUMENT   | INVALID_VERIFICATION_CODE       | ErrorDetail   | Verification code is invalid, expired, or max attempts exceeded |
| INVALID_ARGUMENT   | WEAK_PASSWORD                   | ErrorDetail   | Password does not meet strength requirements               |
| UNAUTHENTICATED    | INVALID_TOKEN                   | ErrorDetail   | Token is invalid, expired, or revoked                      |
| UNAUTHENTICATED    | TOKEN_EXPIRED                   | ErrorDetail   | Access or refresh token has expired                        |
| UNAUTHENTICATED    | SOCIAL_AUTH_FAILED              | ErrorDetail   | OAuth provider authentication failed                       |
| RESOURCE_EXHAUSTED | VERIFICATION_CODE_RATE_LIMITED  | ErrorDetail   | Too many verification code requests                        |
| INVALID_ARGUMENT   | PASSWORD_SAME_AS_CURRENT        | ErrorDetail   | New password cannot be the same as the current password     |

## 9. User Service

### 9.1 Service Definition

**File:** `proto/user/v1/user_service.proto`

```protobuf
syntax = "proto3";

package user.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";

service UserService {
  // User CRUD
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc GetUserByIdentifier(GetUserByIdentifierRequest) returns (GetUserByIdentifierResponse);

  // Profile
  rpc UpdateProfile(UpdateProfileRequest) returns (UpdateProfileResponse);
  rpc GetProfile(GetProfileRequest) returns (GetProfileResponse);

  // Avatar
  rpc GenerateAvatarPresignedPost(GenerateAvatarPresignedPostRequest) returns (GenerateAvatarPresignedPostResponse);
  rpc DeleteAvatar(DeleteAvatarRequest) returns (DeleteAvatarResponse);
}
```

### 9.2 Message Definitions

#### User CRUD Messages

```protobuf
message CreateUserRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
  string nickname = 3;
}

message CreateUserResponse {
  string user_id = 1;
}

message GetUserRequest {
  string user_id = 1;
}

message GetUserResponse {
  string user_id = 1;
  string email = 2;
  string phone = 3;
  string nickname = 4;
  string status = 5;
  string role = 6;
  string avatar_url = 7;
  string bio = 8;
  google.protobuf.Timestamp created_at = 9;
}

message GetUserByIdentifierRequest {
  string identifier = 1;
  common.v1.IdentifierType identifier_type = 2;
}

message GetUserByIdentifierResponse {
  string user_id = 1;
  string email = 2;
  string phone = 3;
  string nickname = 4;
  string status = 5;
  string role = 6;
}
```

#### Profile Messages

```protobuf
message UpdateProfileRequest {
  string user_id = 1;
  optional string nickname = 2;
  optional string bio = 3;
}

message UpdateProfileResponse {
  string user_id = 1;
  string nickname = 2;
  string bio = 3;
}

message GetProfileRequest {
  string user_id = 1;
}

message GetProfileResponse {
  string user_id = 1;
  string nickname = 2;
  string avatar_url = 3;
  string bio = 4;
}
```

#### Avatar Messages

```protobuf
message GenerateAvatarPresignedPostRequest {
  string user_id = 1;
  string content_type = 2;
  int64 content_length = 3;
}

message GenerateAvatarPresignedPostResponse {
  string url = 1;
  map<string, string> fields = 2;
}

message DeleteAvatarRequest {
  string user_id = 1;
}

message DeleteAvatarResponse {}
```

### 9.3 Error Codes

| gRPC Status        | Reason                 | Detail Type   | Description                                                |
| ------------------ | ---------------------- | ------------- | ---------------------------------------------------------- |
| NOT_FOUND          | USER_NOT_FOUND         | ErrorDetail   | User with the specified ID does not exist                  |
| INVALID_ARGUMENT   | INVALID_NICKNAME       | ErrorDetail   | Nickname is empty or exceeds 30 characters                 |
| INVALID_ARGUMENT   | INVALID_BIO            | ErrorDetail   | Bio exceeds 200 characters                                 |
| INVALID_ARGUMENT   | INVALID_AVATAR_FORMAT  | ErrorDetail   | Avatar image format not supported                          |
| INVALID_ARGUMENT   | AVATAR_TOO_LARGE       | ErrorDetail   | Avatar image exceeds 5 MB size limit                       |
| NOT_FOUND          | AVATAR_NOT_FOUND       | ErrorDetail   | User does not have an avatar to delete                     |
| NOT_FOUND          | PROFILE_NOT_FOUND      | ErrorDetail   | User profile does not exist                                |

## 10. Inter-Service Communication

| Caller         | Callee         | RPC                    | When                                                          |
| -------------- | -------------- | ---------------------- | ------------------------------------------------------------- |
| gateway        | auth-service   | SendVerificationCode   | Client requests registration verification code                |
| gateway        | auth-service   | Register               | Client submits registration form                              |
| gateway        | auth-service   | Login                  | Client logs in with email/phone + password                    |
| gateway        | auth-service   | SocialLogin            | Client logs in with Google or Apple                           |
| gateway        | auth-service   | RefreshToken           | Client refreshes access token                                 |
| gateway        | auth-service   | Logout                 | Client logs out                                               |
| gateway        | auth-service   | ChangePassword         | Client changes password                                       |
| gateway        | auth-service   | SendPasswordResetCode  | Client requests password reset code                           |
| gateway        | auth-service   | ResetPassword          | Client resets password with verification code                 |
| gateway        | user-service   | GetUser                | Client requests own profile (GET /users/me)                   |
| gateway        | user-service   | UpdateProfile          | Client updates profile (PATCH /users/me)                      |
| gateway        | user-service   | GetProfile             | Client views another user's public profile                    |
| gateway        | user-service   | GenerateAvatarPresignedPost | Client requests avatar upload URL                        |
| gateway        | user-service   | DeleteAvatar           | Client deletes avatar                                         |
| auth-service   | user-service   | CreateUser             | During registration after code verification                   |
| auth-service   | user-service   | GetUserByIdentifier    | During login to look up user by email/phone                   |
| auth-service   | user-service   | GetUserByIdentifier    | During social login to check if user exists                   |
| auth-service   | user-service   | GetUserByIdentifier    | During password reset to find user                            |
